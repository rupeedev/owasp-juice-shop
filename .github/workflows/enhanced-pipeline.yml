name: Enhanced Pipeline with Security Scanning

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # Stage 1: Lint (existing)
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install --prefer-offline --no-audit

      - name: Run linter
        run: npm run lint
        continue-on-error: true

  # Stage 2a: SAST (Parallel)
  sast:
    name: SAST - Static Analysis
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install --prefer-offline --no-audit

      - name: Run SAST (npm audit)
        run: |
          echo "ğŸ” Running SAST scan..."
          # TODO: Implement CodeQL or Semgrep
          # For now, use npm audit as basic SAST
          npm audit --audit-level=high || echo "âš ï¸  Vulnerabilities found (warning mode)"
        continue-on-error: true  # Warning mode for training

  # Stage 2b: Secret Detection (Parallel)
  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for secret scanning

      - name: Run Secret Detection
        run: |
          echo "ğŸ” Scanning for secrets in git history..."
          # TODO: Implement TruffleHog or detect-secrets
          # For now, use basic git secrets check
          git log --all --pretty=format: --name-only | sort -u | xargs grep -i "password\|secret\|key" || echo "âœ… No obvious secrets found"
        continue-on-error: true  # Warning mode for training

  # Stage 2c: Unit Tests (Parallel)
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install --prefer-offline --no-audit

      - name: Run unit tests
        run: npm test
        continue-on-error: true  # Warning mode for training

  # Stage 3: Security Scan (Advanced - runs after all Stage 2 jobs)
  security-scan:
    name: ${{ matrix.scan.display }}
    runs-on: ubuntu-latest
    needs: [sast, secret-detection, test]
    strategy:
      fail-fast: false  # Run all scans even if one fails
      matrix:
        scan:
          - name: npm-audit
            display: "npm Audit"
            tool: npm
          - name: trivy
            display: "Trivy Container Scan"
            tool: trivy
          - name: gitleaks
            display: "Gitleaks Secrets"
            tool: gitleaks
          - name: retirejs
            display: "RetireJS"
            tool: retire

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
        if: matrix.scan.name == 'npm-audit' || matrix.scan.name == 'retirejs'

      # npm audit
      - name: Run npm audit
        if: matrix.scan.name == 'npm-audit'
        run: |
          echo "ğŸ“¦ Running npm audit..."
          npm audit --audit-level=moderate || echo "âš ï¸  Vulnerabilities found (warning mode)"
        continue-on-error: true

      # Trivy container scan
      - name: Run Trivy scan
        if: matrix.scan.name == 'trivy'
        run: |
          echo "ğŸ³ Running Trivy container scan..."
          # Build image first
          docker build -t juice-shop:scan .
          # Install Trivy
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy
          # Scan image
          trivy image --severity HIGH,CRITICAL juice-shop:scan || echo "âš ï¸  Vulnerabilities found (warning mode)"
        continue-on-error: true

      # Gitleaks secret scanning
      - name: Run Gitleaks
        if: matrix.scan.name == 'gitleaks'
        run: |
          echo "ğŸ” Running Gitleaks secret scan..."
          docker run --rm -v $(pwd):/repo zricethezav/gitleaks:latest detect --source /repo --verbose || echo "âš ï¸  Secrets found (warning mode)"
        continue-on-error: true

      # RetireJS
      - name: Run RetireJS
        if: matrix.scan.name == 'retirejs'
        run: |
          echo "ğŸ“š Running RetireJS scan..."
          npm install -g retire
          retire --path . || echo "âš ï¸  Vulnerable libraries found (warning mode)"
        continue-on-error: true

  # OPA/Conftest - Dockerfile policy check (can run in parallel with Stage 2)
  dockerfile-policy:
    name: Dockerfile Policy Validation
    runs-on: ubuntu-latest
    needs: lint
    continue-on-error: true  # Don't block subsequent stages on policy violations
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run OPA/Conftest
        run: |
          echo "ğŸ“‹ Running OPA/Conftest policy validation..."
          wget -q https://github.com/open-policy-agent/conftest/releases/latest/download/conftest_linux_amd64.tar.gz
          tar xzf conftest_linux_amd64.tar.gz
          sudo mv conftest /usr/local/bin/

          echo "ğŸ” Testing Dockerfile against security policies..."
          set +e  # Disable exit on error
          conftest test Dockerfile --policy ./policy
          CONFTEST_EXIT_CODE=$?
          set -e  # Re-enable exit on error

          if [ $CONFTEST_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "âš ï¸  Policy violations found (exit code: $CONFTEST_EXIT_CODE)"
            echo "ğŸ“ This is expected for training - review violations above"
            echo "âœ… Pipeline continues in warning mode"
          else
            echo "âœ… All Dockerfile policies passed!"
          fi
          exit 0
        continue-on-error: false

  # Stage 4: SonarQube (NEW - Manual gate)
  sonar:
    name: SonarQube Code Quality
    runs-on: ubuntu-latest
    needs: [security-scan, dockerfile-policy]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: SonarQube Scan (placeholder)
        run: |
          echo "ğŸ“Š SonarQube analysis would run here"
          echo "âš ï¸  Note: SonarQube requires server setup"
          echo "   For now, this is a placeholder for future integration"
          # TODO: Implement SonarCloud or self-hosted SonarQube
        continue-on-error: true

  # Stage 5: Build (existing)
  build:
    name: Build & Tag Docker Image
    runs-on: ubuntu-latest
    needs: sonar
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t juice-shop:latest .
          echo "âœ… Docker image built successfully!"

      - name: Tag images
        run: |
          docker tag juice-shop:latest juice-shop:${{ github.sha }}
          docker tag juice-shop:latest juice-shop:enhanced
          echo "ğŸ·ï¸  Images tagged"

      - name: Save Docker image as artifact
        run: |
          docker save juice-shop:latest -o juice-shop-image.tar
          echo "ğŸ’¾ Docker image saved"

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: juice-shop-image.tar
          retention-days: 1

  # Stage 6: Push (existing)
  push-to-dockerhub:
    name: Push to Docker Hub
    runs-on: ubuntu-latest
    needs: build
    env:
      DOCKER_USERNAME: rupeedev
      DOCKER_REPO: owasp-juice-shop
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i juice-shop-image.tar

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag and push images
        run: |
          docker tag juice-shop:latest ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPO }}:latest
          docker tag juice-shop:latest ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPO }}:${{ github.sha }}
          docker tag juice-shop:latest ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPO }}:enhanced

          docker push ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPO }}:latest
          docker push ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPO }}:${{ github.sha }}
          docker push ${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPO }}:enhanced

  # Stage 7: Deploy (existing)
  deploy:
    name: Deploy to Kubernetes
    runs-on: self-hosted
    needs: push-to-dockerhub
    env:
      DOCKER_USERNAME: rupeedev
      DOCKER_REPO: owasp-juice-shop
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        run: |
          if ! command -v kubectl &> /dev/null; then
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
          fi

      - name: Apply manifests
        run: |
          kubectl apply -f kind-k8s-cluster/juice-shop-deployment.yaml
          kubectl apply -f kind-k8s-cluster/juice-shop-service.yaml

      - name: Update deployment
        run: |
          kubectl set image deployment/juice-shop juice-shop=${{ env.DOCKER_USERNAME }}/${{ env.DOCKER_REPO }}:${{ github.sha }}

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/juice-shop --timeout=180s

      - name: Verify deployment
        run: |
          kubectl get pods -l app=juice-shop
          kubectl get svc juice-shop
          kubectl get deployment juice-shop

      - name: Get service endpoint
        run: |
          echo "ğŸŒ Application deployed at: http://localhost:30080"
        id: endpoint

  # Stage 8: K8s Security (NEW - DAST)
  k8s-security:
    name: K8s Security - DAST
    runs-on: self-hosted
    needs: deploy
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl (if not present)
        run: |
          if ! command -v kubectl &> /dev/null; then
            echo "ğŸ“¥ Installing kubectl..."
            curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
            chmod +x kubectl
            sudo mv kubectl /usr/local/bin/
            echo "âœ… kubectl installed"
          else
            echo "âœ… kubectl already installed"
          fi

      - name: Wait for application readiness
        run: |
          echo "â³ Waiting for application to be ready..."
          sleep 30
          kubectl wait --for=condition=ready pod -l app=juice-shop --timeout=120s

      # OWASP ZAP Baseline Scan
      - name: Run OWASP ZAP Baseline Scan
        run: |
          echo "ğŸ” Running OWASP ZAP baseline scan..."
          docker run --rm --network host \
            owasp/zap2docker-stable:latest \
            zap-baseline.py -t http://localhost:30080 -r zap-report.html || echo "âš ï¸  Security issues found (warning mode)"
        continue-on-error: true

      # Security Headers Check
      - name: Check Security Headers
        run: |
          echo "ğŸ”’ Checking security headers..."
          curl -I http://localhost:30080 | grep -E "Content-Security-Policy|X-Frame-Options|Strict-Transport-Security|X-Content-Type-Options|X-XSS-Protection" || echo "âš ï¸  Missing security headers (expected for Juice Shop)"
        continue-on-error: true

      - name: Security scan complete
        run: |
          echo "âœ… K8s Security scans completed"
          echo "ğŸ“Š Review DAST results for security findings"
          echo "âš ï¸  Note: Juice Shop is intentionally vulnerable - findings are expected"

  # Final success message
  pipeline-complete:
    name: Pipeline Complete
    runs-on: ubuntu-latest
    needs: k8s-security
    steps:
      - name: Success message
        run: |
          echo "ğŸ‰ Enhanced Pipeline completed successfully!"
          echo ""
          echo "âœ… Pipeline Stages (Parallel Execution Optimized):"
          echo "   Stage 1: Lint âœ“"
          echo "   Stage 2: SAST + Secret Detection + Unit Tests (parallel) âœ“"
          echo "   Stage 3: Security Scan (Trivy, Gitleaks, RetireJS - parallel) âœ“"
          echo "           + Dockerfile Policy Validation âœ“"
          echo "   Stage 4: SonarQube Analysis âœ“"
          echo "   Stage 5: Build & Tag Docker Image âœ“"
          echo "   Stage 6: Push to Docker Hub âœ“"
          echo "   Stage 7: Deploy to Kubernetes âœ“"
          echo "   Stage 8: K8s Security (DAST with OWASP ZAP) âœ“"
          echo ""
          echo "âš¡ Parallel execution: SAST, Secrets, Tests, and Policy checks run simultaneously"
          echo "ğŸ”’ Security scanning integrated at multiple stages"
          echo "ğŸ“¦ Application deployed to Kubernetes"
          echo "ğŸŒ Access at: http://localhost:30080"
